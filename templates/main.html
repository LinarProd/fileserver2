<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>File Management</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    {{if .IsAuthorized}}
    <h1>Welcome to File Management</h1>
    <form
      method="post"
      action="/upload"
      enctype="multipart/form-data"
      id="uploadForm"
    >
      <label for="file">Upload File:</label>
      <input type="file" id="file" name="file" required />
      <button type="submit">Upload</button>
    </form>
    <div id="progressContainer" style="display: none; margin-top: 20px">
      <progress id="progressBar" value="0" max="100"></progress>
      <p id="progressStatus">Uploading...</p>
    </div>
    {{if .Files}}
    <h2>Files:</h2>
    {{else}}
    <h2>Список файлов пуст</h2>
    {{end}}
    <ul id="fileList">
      {{range .Files}}
      <li>
        <span>{{.Name}}</span>
        <span class="file-owner">(Owner: {{.Owner}})</span>
        <a href="/download?filename={{.Name}}" download>Download</a>
        {{if or (eq .Owner $.Username) $.IsAdmin}}
        <form method="post" action="/delete" style="display: inline">
          <input type="hidden" name="filename" value="{{.Name}}" />
          <button type="submit">Delete</button>
        </form>
        {{end}}
      </li>
      {{end}}
    </ul>
    <form method="post" action="/logout" style="margin-top: 20px">
      <button type="submit">Logout</button>
    </form>
    {{else}}
    <div class="auth-container">
        <div class="login-section">
            <h2>Вход</h2>
            <form method="post" action="/">
                <label for="username">Имя пользователя:</label>
                <input type="text" id="username" name="username" required />
                <br />
                <label for="password">Пароль:</label>
                <input type="password" id="password" name="password" required />
                <br />
                <button type="submit">Войти</button>
            </form>
        </div>

        <div class="register-section">
            <h2>Регистрация</h2>
            <form method="post" action="/register">
                <label for="reg-username">Имя пользователя:</label>
                <input type="text" id="reg-username" name="username" required />
                <br />
                <label for="reg-password">Пароль:</label>
                <input type="password" id="reg-password" name="password" required />
                <br />
                <button type="submit">Зарегистрироваться</button>
            </form>
        </div>
    </div>
    {{end}}
    <script>
// Обработчик отправки формы загрузки файла
document.getElementById('uploadForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const form = event.target;
    const fileInput = document.getElementById('file');
    const file = fileInput.files[0];

    // Проверка наличия файла
    if (!file) {
        alert('Please select a file to upload.');
        return;
    }

    // Получаем элементы прогресс-бара
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');

    const xhr = new XMLHttpRequest();
    xhr.open('POST', form.action, true);

    // Обработчик прогресса загрузки
    xhr.upload.onprogress = function(event) {
        if (event.lengthComputable) {
            const percentComplete = Math.round((event.loaded / event.total) * 100);
            progressBar.value = percentComplete;
            progressStatus.textContent = `Uploaded ${event.loaded} of ${event.total} bytes (${percentComplete}%)`;
        }
    };

    // Обработчик завершения загрузки
    xhr.onload = function() {
        if (xhr.status === 200) {
            alert('File uploaded successfully!');
            progressContainer.style.display = 'none';
            progressBar.value = 0;
            progressStatus.textContent = '';
            fileInput.value = ''; // Очистка поля ввода файла
            // Обновляем страницу для отображения нового списка файлов
            window.location.reload();
        } else {
            alert('Failed to upload file.');
        }
    };

    // Обработчик ошибки загрузки
    xhr.onerror = function() {
        alert('An error occurred while uploading the file.');
    };

    // Отправляем файл
    progressContainer.style.display = 'block';
    const formData = new FormData(form);
    xhr.send(formData);
});

// Функция обновления списка файлов
function updateFileList() {
    const fileList = document.querySelector('ul');
    const fileHeader = document.querySelector('h2');
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/files', true);
    
    xhr.onload = function() {
        if (xhr.status === 200) {
            const files = JSON.parse(xhr.responseText);
            fileList.innerHTML = ''; // Очистка текущего списка
            
            // Обновляем заголовок в зависимости от наличия файлов
            fileHeader.textContent = files.length > 0 ? 'Files:' : 'Список файлов пуст';
            
            // Создаем элементы списка файлов
            files.forEach(function(file) {
                const li = document.createElement('li');
                
                // Создаем элемент для имени файла
                const nameSpan = document.createElement('span');
                nameSpan.textContent = file.Name;
                
                // Создаем элемент для владельца
                const ownerSpan = document.createElement('span');
                ownerSpan.className = 'file-owner';
                ownerSpan.textContent = `(Owner: ${file.Owner})`;
                
                // Создаем ссылку для скачивания
                const downloadLink = document.createElement('a');
                downloadLink.href = `/download?filename=${file.Name}`;
                downloadLink.textContent = 'Download';
                downloadLink.download = true;

                // Добавляем элементы в li
                li.appendChild(nameSpan);
                li.appendChild(ownerSpan);
                li.appendChild(downloadLink);

                // Добавляем кнопку удаления только если есть права
                if (file.can_delete) {
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/delete';
                    form.style.display = 'inline';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'filename';
                    input.value = file.Name;

                    const button = document.createElement('button');
                    button.type = 'submit';
                    button.textContent = 'Delete';

                    form.appendChild(input);
                    form.appendChild(button);
                    li.appendChild(form);
                }

                fileList.appendChild(li);
            });
        }
    };
    xhr.send();
}
    </script>
  </body>
</html>
